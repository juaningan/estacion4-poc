require 'puppet'
require 'net/https'
require 'uri'
require 'json'

Puppet::Reports.register_report(:consul_kv) do
  def process
    configdir = File.dirname(Puppet.settings[:config])
    configfile = File.join(configdir, 'consul_kv.yaml')
    raise(Puppet::ParseError, "Consul KV report config file #{configfile} not readable") unless File.file?(configfile)

    @config = YAML.load_file(configfile)
    uri = URI.parse(@config["consul_url"] || 'localhost:8500')
    @consul = Net::HTTP.new(uri.host, uri.port)


  end

  def put_value(consul, k, v)
    req = Net::HTTP::Put.new(key_path(k))
    req.body = v
    res = consul.request(req)
    case res
    when Net::HTTPOK
      Puppet.err("Report saved to key %s, %s" % [key_path(k), res.body])
    else
      Puppet.err("Report save failed: %s=%s, error: %s(%s)" % [key_path(k), v, res.body, res.inspect])
    end
  end

  def key_path(slug=nil)
    ["v1", "kv", "puppet_report", self.host, slug].compact.join("/")
  end

  def build_report
  end
end
